import{r as l,j as e,an as b,a7 as Ce,a8 as we,a9 as u,aa as Se,ap as _,ag as x,af as y,as as J,ah as Ee}from"./index-sxY2vR_b.js";import{P as ke}from"./index-AsMD9Xvv.js";import{T as Q}from"./index-AN3niVhH.js";import{u as Fe,f as W,g as Oe,a as Te,b as Re}from"./index-AdiLc_ck.js";import{f as X,i as Me,k as Ie,l as He,m as Be}from"./index.esm-7rMJeW_p.js";import{B as v}from"./Button-gHfU8a9b.js";import{t as p,N as g}from"./toast-N-ApZxOe.js";import"./Alert-1kxoHLt1.js";import"./index-168mgl0G.js";import"./Badge-WPmbxsX2.js";import"./Calendar-ZgfSp0Fx.js";import"./Card-3z76uwgw.js";import"./index-0cCTVzk8.js";import"./index-JPCr6e7Q.js";import{D as Y}from"./Dialog-FwOZiQ_s.js";import{D as Ve}from"./Drawer-KaX1Kqot.js";import"./index-2djQTcgN.js";import"./FormItem-ICRO4P5i.js";import"./Input-ZPP_AMg7.js";import"./index-I4EIx4PY.js";import"./index-jl_zHUR_.js";import"./index-TkDSRGw1.js";import"./Progress-p9IPJkjX.js";import"./index-QXg7WEm2.js";import"./RangeCalendar-g4odKOuj.js";import"./ScrollBar-k_2w5HU3.js";import"./index-lXV4h-Rf.js";import"./Select-vJOz7BTD.js";import"./Skeleton-zGhQ9bnn.js";import"./index-TP-BM9LS.js";import{S as Ae}from"./Switcher-VFtKx0K1.js";import"./index-JXMUYVq9.js";import"./Tag-5NPWn_uT.js";import"./index-uGSpJKVA.js";import"./index-onWM9cyH.js";import"./Tooltip-tOnNgS6K.js";import"./Upload-GAFqS9aY.js";import{O as ze,D as Ke}from"./index.esm-cN1LGhJ4.js";import{u as H,w as Ue}from"./xlsx-b-y62sF7.js";import"./context-ugtK0z0w.js";import"./useTimeout-KcO8uHA1.js";import"./CloseButton-zdejdkm_.js";import"./StatusIcon-KQcZjBe0.js";import"./chainedFunction-ltcSYACe.js";import"./motion-h-3axnRn.js";import"./useMergeRef-Rt_Crb27.js";import"./useControllableState-ID83Xmrm.js";import"./cloneDeep-zb5lPSU-.js";import"./_getAllKeys--cIPhckb.js";import"./_MapCache-2jaa7x3q.js";import"./Views-YxvfAhNX.js";import"./_baseIsEqual-mdoAGwaV.js";import"./get-Hn36fiWU.js";import"./toString-O8bkrTIN.js";import"./floating-ui.react-xh7t2hCc.js";import"./floating-ui.dom-0rLBacrf.js";import"./TimeInput-AHD-Ag0H.js";import"./useUniqueId-Oy16QHov.js";import"./useDidUpdate-6tzSgSG9.js";import"./index-gZB_DS34.js";import"./index-t_CREONj.js";import"./useRootClose-E9p0nRhu.js";import"./isNil-e2_r07uT.js";import"./index-beo0AS2x.js";import"./toConsumableArray-YYxflNc8.js";import"./objectWithoutPropertiesLoose-pdUxmcoj.js";import"./setPrototypeOf-ahVgEFUp.js";import"./mapCloneElement-dQmo0QW8.js";import"./index.esm-lAhGiBpp.js";import"./index.esm-LGScvnh4.js";const Le=()=>{const[B,Z]=l.useState([]),[ee,D]=l.useState([]),[ae,V]=l.useState(!1),[A,oe]=l.useState("nombre"),[C,te]=l.useState(""),[a,w]=l.useState(null),[re,N]=l.useState(!1),[S,z]=l.useState(""),[E,K]=l.useState(""),[se,k]=l.useState(!1),[m,F]=l.useState(null),f=async()=>{const o=Ce(we(u,"Subscripciones")),i=(await Se(o)).docs.map(async d=>{const n=d.data();let h="Taller no encontrado",j="Correo no encontrado";if(n.taller_uid){const s=await _(x(u,"Usuarios",n.taller_uid));if(s.exists()){const r=s.data();h=r.nombre||"Taller no encontrado",j=r.email||"Correo no encontrado"}}return{...n,uid:d.id,nombre_taller:h,correo_taller:j}}),c=await Promise.all(i);Z(c)};l.useEffect(()=>{f()},[]);const ne=async()=>{await f(),p.push(e.jsx(g,{title:"Datos actualizados",children:"La tabla ha sido actualizada con éxito."}))},ie=()=>{V(!0)},O=()=>{V(!1),z(""),K("")},le=o=>{w(o),N(!0)},ce=async()=>{if(a)try{let o;if(console.log("selectedPerson",a),a.status==="Por Aprobar"){if(o={status:a.status,fecha_inicio:null,fecha_fin:null,monto:a.monto??"",nombre:a.nombre,vigencia:a.vigencia},await y(x(u,"Subscripciones",a.uid),o),a.taller_uid){await y(x(u,"Usuarios",a.taller_uid),{subscripcion_actual:o});const d=await _(x(u,"Usuarios",a.taller_uid));if(d.exists()){const n=d.data();console.log("userData",n);try{await J.post("https://apisolvers.solversapp.com/api/usuarios/sendNotification",{token:n==null?void 0:n.token,title:"Codigo Validado",body:"Hola, se ha rechazado su pago",secretCode:"Validar codigo"})}catch(h){console.error("Error al enviar notificación:",h)}}}p.push(e.jsx(g,{title:"Éxito",children:"Subscripción actualizada con éxito."})),N(!1),f();return}else if(a.taller_uid){const d=await _(x(u,"Usuarios",a.taller_uid));if(d.exists()){const n=d.data();console.log("userData",n);try{await J.post("https://apisolvers.solversapp.com/api/usuarios/sendNotification",{token:n==null?void 0:n.token,title:"Codigo Validado",body:"Hola, se ha validado su pago exitosamente",secretCode:"Validar codigo"})}catch(h){console.error("Error al enviar notificación:",h)}}}const t=new Date,i=parseInt(a.vigencia,10);if(isNaN(i)){p.push(e.jsx(g,{title:"Error",children:"La vigencia proporcionada no es válida."}));return}const c=new Date(t);c.setDate(t.getDate()+i),o={nombre:a.nombre,vigencia:a.vigencia,fecha_inicio:b.fromDate(t),fecha_fin:b.fromDate(c),status:a.status,cantidad_servicios:a.cantidad_servicios,monto:a.monto},await y(x(u,"Subscripciones",a.uid),o),a.taller_uid&&await y(x(u,"Usuarios",a.taller_uid),{subscripcion_actual:o}),p.push(e.jsx(g,{title:"Éxito",children:"Subscripción actualizada con éxito."})),N(!1),f()}catch(o){console.error("Error actualizando la subscripción:",o),p.push(e.jsx(g,{title:"Error",children:"Hubo un error al actualizar la subscripción."}))}},T=o=>o instanceof b?o.toDate().toLocaleDateString("es-ES"):"-",{Tr:U,Th:de,Td:me,THead:ue,TBody:pe,Sorter:qe}=Q,ge=o=>{console.log("Drawer cerrado",o),N(!1),w(null)},xe=o=>{F(o),k(!0)},he=async()=>{if(m)try{if(await Ee(x(u,"Subscripciones",m.uid)),m.taller_uid){const o=x(u,"Usuarios",m.taller_uid);(await _(o)).exists()&&await y(o,{subscripcion_actual:null})}p.push(e.jsx(g,{title:"Suscripción eliminada",children:"La suscripción ha sido eliminada exitosamente."})),k(!1),F(null),f()}catch(o){console.error("Error eliminando la suscripción:",o),p.push(e.jsx(g,{title:"Error",children:"Hubo un error al eliminar la suscripción."}))}},L=()=>{k(!1),F(null)},[q,be]=l.useState(1),R=6,fe=o=>{console.log("onPaginationChange",o),be(o)},P=(q-1)*R,je=P+R,ye=o=>{const t=o.target.value;te(t),D([{id:A,value:t}])},ve=o=>{const t=o.target.value;oe(t),C!==""&&D([{id:t,value:C}])},Ne=()=>{if(!S||!E){p.push(e.jsx(g,{title:"Fechas incompletas",children:"Por favor, selecciona ambas fechas para continuar."}));return}const o=new Date(S);o.setUTCHours(0,0,0,0);const t=new Date(E);t.setUTCHours(23,59,59,999),console.log({startDate:o,endDate:t});const i=["nombre","nombre_taller","cantidad_servicios","monto","fecha_inicio","fecha_fin","status"],c={nombre:"Nombre Cliente",nombre_taller:"Nombre Taller",cantidad_servicios:"Cantidad de Servicios",monto:"Monto Total",fecha_inicio:"Fecha de Inicio",fecha_fin:"Fecha de Fin",status:"Estado"},d=B.filter(s=>{const r=s.fecha_inicio instanceof b?s.fecha_inicio.toDate():new Date(s.fecha_inicio);return!(r instanceof Date)||isNaN(r.getTime())?!1:(console.log("Fecha Inicio:",r,"Inicio Range:",o,"End Range:",t),r.getTime()>=o.getTime()&&r.getTime()<=t.getTime())});if(d.length===0){p.push(e.jsx(g,{title:"Sin datos para exportar",children:"No hay datos disponibles en el rango de fechas seleccionado."}));return}const n=d.map(s=>{const r={};return i.forEach(M=>{const I=s[M],De=c[M]||M;r[De]=I instanceof b?I.toDate().toISOString().split("T")[0]:I??""}),s.comprobante_pago&&(r["Método Comprobante"]=s.comprobante_pago.metodo||"",r["Banco Origen"]=s.comprobante_pago.bancoOrigen||"",r["Banco Destino"]=s.comprobante_pago.bancoDestino||"",r.Cédula=s.comprobante_pago.cedula||"",r["Teléfono Comprobante"]=s.comprobante_pago.telefono||"",r.Monto=s.comprobante_pago.monto||"",r.Recibo=s.comprobante_pago.receiptFile||"",r["Número Referencia"]=s.comprobante_pago.numReferencia||"",r["Fecha Pago"]=s.comprobante_pago.fechaPago?T(s.comprobante_pago.fechaPago):"-",r["Correo Comprobante"]=s.comprobante_pago.correo||""),r}),h=H.json_to_sheet(n),j=H.book_new();H.book_append_sheet(j,h,"Subscripciones"),Ue(j,"subscripciones.xlsx"),p.push(e.jsx(g,{title:"Exportación exitosa",children:"El archivo Excel se ha descargado correctamente."})),O()},$=Fe({data:B,columns:[{header:"Plan",accessorKey:"nombre"},{header:"Taller Subscrito",accessorKey:"nombre_taller"},{header:"Correo Taller",accessorKey:"correo_taller"},{header:"Cantidad de Servicios",accessorKey:"cantidad_servicios"},{header:"Monto",accessorKey:"monto"},{header:"Fecha de Aprobacion",accessorKey:"fecha_inicio",cell:({row:o})=>{const t=o.original.fecha_inicio;return t?T(t):"-"}},{header:"Vigente Hasta",accessorKey:"fecha_fin",cell:({row:o})=>{const t=o.original.fecha_fin;return t?T(t):"-"}},{header:"Estado",accessorKey:"status",cell:({row:o})=>{const t=o.getValue("status");let i,c;switch(t){case"Aprobado":i=e.jsx(Be,{className:"text-green-500 mr-1"}),c="text-green-500";break;case"Vencido":i=e.jsx(He,{className:"text-red-500 mr-1"}),c="text-red-500";break;case"Por Aprobar":i=e.jsx(Ie,{className:"text-yellow-500 mr-1"}),c="text-yellow-500";break;default:i=null}return e.jsxs("div",{className:`flex items-center ${c}`,children:[i,e.jsx("span",{children:t})]})}},{header:"Acciones",cell:({row:o})=>{const t=o.original;return e.jsxs("div",{className:"flex gap-2",children:[t.status!=="Vencido"&&t.comprobante_pago&&e.jsx("button",{onClick:()=>le(t),className:"text-blue-900 hover:text-blue-700 transition-colors duration-200 p-1 rounded hover:bg-blue-50",title:"Ver detalles",children:e.jsx(Me,{})}),e.jsx("button",{onClick:()=>xe(t),className:"text-red-600 hover:text-red-800 transition-colors duration-200 p-1 rounded hover:bg-red-50",title:"Eliminar suscripción",children:e.jsx(X,{})})]})}}],state:{columnFilters:ee},onColumnFiltersChange:D,getCoreRowModel:Oe(),getSortedRowModel:Te(),getFilteredRowModel:Re()}),G=$.getRowModel().rows,_e=G.length;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("h1",{className:"mb-6 flex justify-start items-center space-x-4",children:[e.jsx("span",{className:"text-[#000B7E]",children:"Subscripciones"}),e.jsx("button",{className:"p-2 bg-slate-100 hover:bg-slate-200 active:bg-slate-300 transition-all duration-200 shadow-md transform hover:scale-105 rounded-md",onClick:ne,children:e.jsx(ze,{className:"w-5 h-5 text-gray-700 hover:text-blue-500 transition-colors duration-200"})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"relative w-24",children:e.jsxs("select",{className:"h-10 w-full py-2 px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onChange:ve,value:A,children:[e.jsx("option",{value:"",disabled:!0,children:"Seleccionar columna..."}),e.jsx("option",{value:"nombre",children:"Plan"}),e.jsx("option",{value:"nombre_taller",children:"Taller"}),e.jsx("option",{value:"status",children:"Estado"})]})}),e.jsxs("div",{className:"relative w-80 ml-4",children:[e.jsx("input",{type:"text",placeholder:"Buscar...",className:"w-full py-2 px-4 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 h-10",value:C,onChange:ye}),e.jsx(Ke,{className:"absolute left-3 top-5 transform -translate-y-1/2 text-gray-500 w-5 h-5"})]}),e.jsx("button",{style:{backgroundColor:"#000B7E"},className:"p-2 ml-4 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 active:bg-blue-700 transition duration-200 hover:opacity-80",onClick:ie,children:"Exportar a Excel"})]})})]}),e.jsxs("div",{className:"p-1 rounded-lg shadow",children:[e.jsxs(Q,{className:"w-full  rounded-lg",children:[e.jsx(ue,{children:$.getHeaderGroups().map(o=>e.jsx(U,{children:o.headers.map(t=>e.jsx(de,{colSpan:t.colSpan,children:t.isPlaceholder?null:e.jsx("div",{className:t.column.getCanSort()?"cursor-pointer select-none":"",onClick:t.column.getToggleSortingHandler(),children:W(t.column.columnDef.header,t.getContext())})},t.id))},o.id))}),e.jsx(pe,{children:G.slice(P,je).map(o=>e.jsx(U,{children:o.getVisibleCells().map(t=>e.jsx(me,{children:W(t.column.columnDef.cell,t.getContext())},t.id))},o.id))})]}),e.jsx(ke,{onChange:fe,currentPage:q,totalRows:_e,rowsPerPage:R})]}),e.jsxs(Ve,{isOpen:re,onClose:ge,className:"rounded-md shadow",children:[e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsx("h2",{className:"flex mb-4 text-xl font-bold",children:"Revisión de Pago"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ae,{defaultChecked:(a==null?void 0:a.status)==="Aprobado",onChange:o=>w(t=>({...t??{nombre:"",cantidad_servicios:"",monto:"",uid:"",vigencia:"",id:"",status:""},status:o?"Aprobado":"Por Aprobar"})),color:(a==null?void 0:a.status)==="Aprobado"?"green-500":"red-500"}),e.jsx("span",{className:"ml-2 text-gray-700",children:a==null?void 0:a.status})," "]})]}),e.jsxs("div",{className:"flex flex-col space-y-6",children:[" ",(a==null?void 0:a.comprobante_pago.metodo)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Metodo de Pago:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.metodo,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.fechaPago)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Fecha de Pago:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.fechaPago instanceof b?new Date(a.comprobante_pago.fechaPago.toDate()).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}):new Date(a.comprobante_pago.fechaPago).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}),readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.bancoOrigen)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Banco Origen:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.bancoOrigen,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.bancoDestino)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Banco Destino:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.bancoDestino,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.correo)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Correo:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.correo,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.cedula)!==void 0&&a.comprobante_pago.cedula!==0&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Cédula:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.cedula,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.telefono)!==void 0&&a.comprobante_pago.telefono!==0&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Telefono:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.telefono,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.monto)!==void 0&&a.comprobante_pago.monto!==0&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Monto:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.monto,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.numReferencia)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Numero de referencia:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.numReferencia,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]}),(a==null?void 0:a.comprobante_pago.receiptFile)&&e.jsxs("label",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Comprobante de pago:"}),e.jsx("input",{type:"text",value:a.comprobante_pago.receiptFile,readOnly:!0,className:"mt-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"})]})]}),e.jsx("div",{className:"text-center mt-6 ",children:e.jsx(v,{onClick:ce,style:{backgroundColor:"#000B7E"},className:"text-white hover:opacity-80",children:"Guardar Cambios"})})]}),e.jsx(Y,{isOpen:ae,onClose:O,children:e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Seleccionar Rango de Fechas"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"block text-sm",children:"Desde:"}),e.jsx("input",{id:"startDate",type:"date",value:S,onChange:o=>z(o.target.value),className:"w-full border border-gray-300 rounded-md p-2"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"block text-sm",children:"Hasta:"}),e.jsx("input",{id:"endDate",type:"date",value:E,onChange:o=>K(o.target.value),className:"w-full border border-gray-300 rounded-md p-2"})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-4",children:[e.jsx(v,{onClick:O,children:"Cancelar"}),e.jsx(v,{onClick:Ne,className:"text-white hover:opacity-80",style:{backgroundColor:"#000B7E"},children:"Exportar"})]})]})}),e.jsx(Y,{isOpen:se,onClose:L,children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center mb-4",children:e.jsx("div",{className:"flex-shrink-0 w-10 h-10 mx-auto bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(X,{className:"w-6 h-6 text-red-600"})})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"¿Eliminar suscripción?"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-6",children:["Esta acción no se puede deshacer. Se eliminará permanentemente la suscripción de"," ",e.jsx("span",{className:"font-semibold text-gray-900",children:m==null?void 0:m.nombre})," ","para el taller"," ",e.jsx("span",{className:"font-semibold text-gray-900",children:m==null?void 0:m.nombre_taller}),"."]}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx(v,{onClick:L,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Cancelar"}),e.jsx(v,{onClick:he,className:"px-4 py-2 text-sm font-medium text-white border border-transparent rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",style:{backgroundColor:"#dc2626"},onMouseEnter:o=>o.target.style.backgroundColor="#991b1b",onMouseLeave:o=>o.target.style.backgroundColor="#dc2626",children:"Eliminar"})]})]})]})})]})},lo=Le;export{lo as default};
